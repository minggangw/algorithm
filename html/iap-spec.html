<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <title>
      In-App Purchase API
    </title>
    <script src='../js/require.js' data-main='../js/profile-w3c-common' async class='remove'></script>
    <script class="remove">
    var respecConfig = {
        specStatus: 'ED',
        edDraftURI: 'http://10.238.157.53/html/iap.html',
        shortName:  'IAP-api',
        editors: [
          {
            w3cid: 63802,
            name: 'Minggang Wang',
            company: 'Intel',
            note: 'until Nov 2015'
          }
        ],
        previousMaturity: 'WD',
        previousPublishDate: '2015-07-01',
        localBiblio: {
          PROMGUIDE: {
            title: 'Writing Promise-Using Specifications',
            href: 'http://www.w3.org/2001/tag/doc/promises-guide',
            authors: [
              'Domenic Denicola'
            ],
            status: 'finding',
            publisher: 'W3C'
          }
        },
      };
    </script>
    <style>
    /* Note formatting taken from HTML5 spec */
    .note { border-left-style: solid; border-left-width: 0.25em; background: none repeat scroll 0 0 #E9FBE9; border-color: #52E052; }
    .note em, .warning em, .note i, .warning i { font-style: normal; }
    p.note, div.note { padding: 0.5em 2em; }
    span.note { padding: 0 2em; }
    .note p:first-child { margin-top: 0; }
    .note p:last-child { margin-bottom: 0; }
    p.note:before { content: 'NOTE: '; }
    .non-normative { border-left-style: solid; border-left-width: 0.25em; background: none repeat scroll 0 0 #E9FBE9; border-color: #52E052; }
    p.non-normative:before { content: 'Non-normative: '; font-weight: bolder;}
    p.non-normative, div.non-normative { padding: 0.5em 2em; }


    /* Pre.idl formatting taken from HTML5 spec */
    pre.idl { border: solid thin #d3d3d3; background: #FCFCFC; color: black; padding: 0.5em 1em; position: relative; }
    pre.idl :link, pre.idl :visited { color: inherit; background: transparent; }
    pre.idl::before { content: "IDL"; font: bold small sans-serif;
    padding: 0.5em; background: white; position: absolute; top: 0;
    margin: -1px 0 0 -4em; width: 1.5em; border: thin solid;
    border-radius: 0 0 0 0.5em }

    /* .example idl formatting taken from HTML5 nightly spec */
    .example {
        display: block;
        color: #222222;
        background: #FCFCFC;
        border-left-style: solid;
        border-color: #c0c0c0;
        border-left-width: 0.25em;
        margin-left: 1em;
        padding-left: 1em;
        padding-bottom: 0.5em;
    }

    .algorithm li {
        margin-bottom: 0.5em;
    }

    .interface dd, .parameters dt {
        margin-bottom: 0.5em;
    }

    code { color: orangered; }
    table { border-collapse: collapse; border-style: hidden hidden none hidden; }
    table thead, table tbody { border-bottom: solid; }
    table td, table th { border-left: solid; border-right: solid; border-bottom: solid thin; vertical-align: top; padding: 0.2em; }
    dfn { font-weight: bolder; font-style: normal; }
    .copyright { font-size: small; }
    .issue[id^='issue-'] > *:not([role='heading']) { display: none; }
    </style>
  </head>
  <body>
    <section id="abstract">
      <p>
        This specification defines an API to enable in-app purchase on web.
      </p>
    </section>
    <section id="sotd">
      <p>
        This document is a <b>work in progress</b> and is subject to change.
        Some sections are still incomplete or underspecified. <a href=
        "#security-and-privacy-considerations">Security and privacy
        considerations</a> need to be adjusted based on feedback and
        experience. Some open issues are noted inline; please check the group's
        <a href="https://github.com/w3c/presentation-api/issues">issue
        tracker</a> on GitHub for all open issues.
      </p>
    </section>
    <section class="informative">
      <h2>
        Introduction
      </h2>
      <p>
      	This specification aims to make In-App Purchase(IAP) such as Google Play or Apple Store,
      	available to the Web. Nowadays, user can purchase virtual goods within paid or free
      	apps. The app can offer customers additional digital content, functionality, services
      	and even subscriptions.
      </p>
      <p>
      	At its core, the <a href="#idl-def-iap"><code>iap</code></a> enables all necessary
      	operations in IAP.
      </p>
    </section>
  
    <section>
      <h2>
        Terminology
      </h2>
      <p>
        This document provides interface definitions using the Web IDL standard
        ([[!WEBIDL]]). The terms <dfn><a href=
        "https://heycam.github.io/webidl/#idl-promise">Promise</a></dfn>,
        <dfn><a href=
        "http://heycam.github.io/webidl/#idl-ArrayBuffer">ArrayBuffer</a></dfn>,
        <dfn><a href=
        "http://heycam.github.io/webidl/#idl-ArrayBufferView">ArrayBufferView</a></dfn>
        and <dfn><a href=
        "http://heycam.github.io/webidl/#idl-DOMException">DOMException</a></dfn>
        are defined in [[!WEBIDL]].
      </p>
      <p>
        The terms <dfn data-lt="resolve"><a href=
        "http://www.w3.org/2001/tag/doc/promises-guide#resolve-promise">resolving
        a Promise</a></dfn>, and <dfn data-lt="reject"><a href=
        "http://www.w3.org/2001/tag/doc/promises-guide#reject-promise">rejecting
        a Promise</a></dfn> are used as explained in [[!PROMGUIDE]].
      </p>
    </section>
    
    <section>
      <h2>
        API
      </h2>
      <section>
        <h3>
          Common idioms
        </h3>

      </section>
     
      <section>
        <h3>
          Interface <a><code>IAP</code></a>
        </h3>
        <pre class="idl">
          partial interface Navigator {
            [SameObject] readonly attribute IAP iap;
          };

        </pre>
        <p>
          The <dfn for="Navigator"><code>iap</code></dfn> attribute is
          used to retrieve an instance of the <a>IAP</a> interface.
        </p>
        <pre class="idl">
          interface IAP : EventTarget {
            // Initialize the purchase.
            Promise&lt;void&gt; init(InitOptions options);

            // Operations.
            Promise&lt;DOMString&gt; getReceipt();
            Promise&lt;void&gt; validateReceipt(DOMString receipt);
            Promise&lt;PurchaseResult&gt; restore();
            Promise&lt;PurchaseResult&gt; buy(PurchaseInfo purchase);
            Promise&lt;sequence&lt;Product&gt;&gt; queryProductsInfo(sequence&lt;DOMString&gt; productIds);
          };
				</pre>

        <section>
          <h4>
            Initializing the <code>iap</code>
          </h4>
          <p>
            When <code><dfn for="IAP">init</dfn>(options)</code> method is called, <code>iap</code> will
            be initiated by the given parameter <code>options</code>, which assigns the channel to select.
          </p>
          <dl>
            <dt>
              Input
            </dt>
            <dd>
              <code>presentationRequest</code>, the
              <code>PresentationRequest</code> object
            </dd>
            <dd>
              <code>presentationUrl</code>, the <a>presentation request URL</a>
            </dd>
            <dt>
              Output
            </dt>
            <dd>
              <em>P</em>, a <a>Promise</a>
            </dd>
          </dl>
          <ol>
            <li>If the <code>iap</code> has already been initialized, return a <a>Promise</a> rejected with
                a DOMExpection named <code>"InvalidStateError"</code>.
            </li>
            <li>
              If the <a href="#widl-InitOptions-channel">channel</a> is empty, return a <a>Promise</a> rejected with a DOMExpection
              named <code>"InvalidAccessError"</code>.
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>Run the following steps:
              <ol>
                <li>
                  Initialize the specified channel.
                </li>
                <li>Wait until the initialization completes.
                </li>
              </ol>
            </li>
            <li>If the specified channel is not suppported, then:
              <ol>
                <li><a>Reject</a> <em>P</em> whith a DOMExpection named <code>"NotSupportedError"</code>.
                </li>
              </ol>
            </li>
            <li>If the error occurs during initialization, then:
              <ol>
                <li>
                  <a>Reject</a> <em>P</em> with a DOMException named <code>"OperationError"</code>.
                </li>
              </ol>
            </li>
            <li>
              <a>Resolve</a> <em>P</em>
            </li>
          </ol>
        </section>
        <section>
          <h4>
            Querying the detailed information of products.
          </h4>
          <p>
            When <code><dfn for="IAP">queryProductsInfo</dfn>(producdIds)</code> method is called,
            <code>iap</code> will get the detailed informations of the products, run the following
            steps:
          </p>
          <dl>
            <dt>
              Input
            </dt>
            <dd>
              <code>presentationRequest</code>, the
              <code>PresentationRequest</code> object
            </dd>
            <dd>
              <code>presentationUrl</code>, the <a>presentation request URL</a>
            </dd>
            <dt>
              Output
            </dt>
            <dd>
              <em>P</em>, a <a>Promise</a>
            </dd>
          </dl>
          <ol>
            <li>
              If the <code>iap</code> has not been initialized, return a <a>Promise</a> rejected with
                a DOMExpection named <code>"InvalidStateError"</code>.
            </li>
            <li>If the productIds is empty, return a <a>Promise</a> rejected with a DOMExpection whose
                name is <code>"IndexSizeError"</code>.
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
              Query the information.
            </li>
            <li>
              If an error occurs then:
              <ol>
                <li>
                  <a>Reject</a> <em>P</em> with a DOMException named <code>"OperationError"</code>.
                </li>
              </ol>
            </li>
            <li>
              If the querying completes successfully, then run the following steps:
              <ol>
                <li>
                  Let <em>array</em> be an empty array.
                </li>
                <li>
                  For each product, add <a href="#idl-def-Product">product</a> to <em>array</em>
                </li>
                <li>
                  <a>Resolve</a> <em>P</em> with <em>array</em>.
                </li>
              </ol>
            </li>
          </ol>
          <div class="note">
            No specific transport for the connection between the <a>controlling
            browsing context</a> and the <a>presenting browsing context</a> is
            mandated, except that for multiple calls to <code><a for=
            "PresentationSession">send</a>()</code> it has to be ensured that
            messages are delivered to the other end reliably and in sequence.
            The transport should function equivalently to an
            <a><code>RTCDataChannel</code></a> in reliable mode.
          </div>
        </section>
        <section>
          <h4>
            Purchasing a product.
          </h4>
          <p>
            When <code><dfn for="IAP">buy</dfn>(purchase)</code> method is called,
            <code>iap</code> will buy the assigned product. 
          </p>
          <dl>
            <dt>
              Input
            </dt>
            <dd>
              <code>presentationRequest</code>, the
              <code>PresentationRequest</code> object
            </dd>
            <dd>
              <code>presentationUrl</code>, the <a>presentation request URL</a>
            </dd>
            <dt>
              Output
            </dt>
            <dd>
              <em>P</em>, a <a>Promise</a>
            </dd>
          </dl>
          <ol>
            <li>
              If the <code>iap</code> has not been initialized, return a <a>Promise</a> rejected with
              a DOMExpection named <code>"InvalidStateError"</code>.
            </li>
            <li>
              If the <a href="#widl-PurchaseResult-productId">productId</a> is undefined, return a 
              promise return a <a>Promise</a> rejected with a DOMExpection named <code>"InvalidAccessError"</code>.
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
              If buying the product successfully, then run the following steps:
              <ol>
                <li>
                  Let <em>S</em> be the pruchased <a href="#idl-def-Product">product</a>.
                </li>
                <li>
                <a>Resolve</a> <em>P</em> with <em>S</em>.
                </li>
              </ol>
            </li>
          </ol>
        </section>
        <section>
          <h4>
            Getting the receipt.
          </h4>
          <p>
            When <code><dfn for="IAP">getReceipt</dfn>()</code> method is called,
            <code>iap</code> will return the receipt of the corresponding channel.
          </p>
          <dl>
            <dt>
              Input
            </dt>
            <dd>
              <code>presentationRequest</code>, the
              <code>PresentationRequest</code> object
            </dd>
            <dd>
              <code>presentationUrl</code>, the <a>presentation request URL</a>
            </dd>
            <dt>
              Output
            </dt>
            <dd>
              <em>P</em>, a <a>Promise</a>
            </dd>
          </dl>
          <ol>
            <li>
              If the <code>iap</code> has not been initialized, return a <a>Promise</a> rejected with
              a DOMExpection named <code>"InvalidStateError"</code>.
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
            	If getting the receipt successfully, then run the following steps:
              <ol>
                <li>
                  <a>Resolve</a> <em>P</em> with the requested receipt.
                </li>
              </ol>
            </li>
          </ol>
        </section>
        <section>
          <h4>
            Validating the receipt.
          </h4>
          <p>
            When <code><dfn for="IAP">validateReceipt</dfn>()</code> method is called,
            <code>iap</code> will validate the receipt.
          </p>
          <dl>
            <dt>
              Input
            </dt>
            <dd>
              <code>presentationRequest</code>, the
              <code>PresentationRequest</code> object
            </dd>
            <dd>
              <code>presentationUrl</code>, the <a>presentation request URL</a>
            </dd>
            <dt>
              Output
            </dt>
            <dd>
              <em>P</em>, a <a>Promise</a>
            </dd>
          </dl>
          <ol>
            <li>
              If the <code>iap</code> has not been initialized, return a <a>Promise</a> rejected with
              a DOMExpection named <code>"InvalidStateError"</code>.
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
            	If getting the receipt successfully, then run the following steps:
              <ol>
                <li>
                  <a>Resolve</a> <em>P</em> with the receipt.
                </li>
              </ol>
            </li>
          </ol>
        </section>
        <section>
          <h4>
            Restoring the purchased products.
          </h4>
          <p>
            When <code><dfn for="IAP">restore</dfn>()</code> method is called,
            <code>iap</code> will restore the previous purchases.
          </p>
          <dl>
            <dt>
              Input
            </dt>
            <dd>
              <code>presentationRequest</code>, the
              <code>PresentationRequest</code> object
            </dd>
            <dd>
              <code>presentationUrl</code>, the <a>presentation request URL</a>
            </dd>
            <dt>
              Output
            </dt>
            <dd>
              <em>P</em>, a <a>Promise</a>
            </dd>
          </dl>
          <ol>
            <li>
              If the <code>iap</code> has not been initialized, return a <a>Promise</a> rejected with
              a DOMExpection named <code>"InvalidStateError"</code>.
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
            	If the task fails, run the following steps:
            	<ol>
            		<li>
            			<a>Reject</a> <em>P</em> with a DOMException named <code>"OperationError"</code>.
            		</li>
            	</ol>
            </li>
            <li>
              If restoring successfully, then run the following steps:
              <ol>
                <li>
                  Let <em>S</em> be the restored <a href="#idl-def-Product">product</a>.
                </li>
                <li>
                <a>Resolve</a> <em>P</em> with  <em>S</em>.
                </li>
              </ol>
            </li>
          </ol>
        </section>

        <section>
        <h2>Dictionaries</h2>
        <p>
        	An <a>InitOptions</a> dictionary is a base type that specifies the <code>iap</code>,
        	such as channel and key attributes.
        </p>
        <dl class="idl" title="dictionary InitOptions">
          <dt>DOMString channel</dt>
          <dd>The name of the channel which you want to select.</dd>
          <dt>DOMString key</dt>
          <dd>The public licensing key of this application if it exists.</dd>
        </dl>
        <p> 
        	A <a>Product</a> dictionary represents a thing sold in the application, which could be
          <ul>
            <li>
              Content
            </li>
            <li>
              Functionality
            </li>
            <li>
              Services
            </li>
            <li>
              Subscriptions
            </li>
          </ul>
        </p>
        <dl class="idl" title="dictionary Product">
          <dt>DOMString productId</dt>
          <dd>The ID of the product.</dd>
          <dt>DOMString title</dt>
          <dd>The title of the product.</dd>
          <dt>DOMString description</dt>
          <dd>A simple description of the product.</dd>
          <dt>DOMString currencyCode</dt>
          <dd>The currency code of this product used.</dd>
          <dt>double price</dt>
          <dd>The price of the product.</dd>
        </dl>
        <p>
        	A <a>PurchaseResult</a> dictionary represents the result of purchase or result when users restore
          transactions to maintain access to content they've already purchased. 
        </p>
        <dl class="idl" title="dictionary PurchaseResult">
          <dt>DOMString productId</dt>
          <dd>The ID of the purchased product.</dd>
          <dt>DOMString transactionId</dt>
          <dd>The transaction ID of this purchase used.</dd>
          <dt>DOMString productReceipt</dt>
          <dd>The receipt of the purchased product.</dd>
          <dt>DOMString packageName</dt>
          <dd>The package name of the application.</dd>
          <dt>DOMString purchaseTime</dt>
          <dd>The time when the purchase happened</dd>
          <dt>DOMString purchaseState</dt>
          <dd>The state of the purchase.</dd>
        </dl>
        <p>
        	A <a>PurchaseInfo</a> dictionary represents the detailed information of the order.
        </p>
        <dl class="idl" title="dictionary PurchaseInfo">
          <dt>DOMString productId</dt>
          <dd>The ID of the purchased product.</dd>
          <dt>DOMString userInfo</dt>
          <dd>The information of the user.</dd>
          <dt>unsigned long count</dt>
          <dd>The quantity of the product.</dd>
          <dt>double price</dt>
          <dd>The price of the product.</dd>
          <dt>dictionary extraInfo</dt>
          <dd>Additional information used to descript the purchase.</dd>
        </dl>
      </section>
    </section>
  </section>
  <section>
    <h2>
      Examples
    </h2>
      <section>
        <h3>
          Initialization example
        </h3>
          <pre class="example highlight">
&lt;script&gt;
  function onload() {
    iap.init({channel:"GooglePlay", key:"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsEVjLWKJ5B7EKjnH5NV"}).then(function() {
      document.getElementById("resultDiv").innerHTML = "Initialization finished.";
    }).catch(function(e) {
      console.log(e.name);
    });
  }
&lt;/script&gt;

&lt;body onload='onload()'&gt;
  &lt;div id="resultDiv"&gt;&lt;/div&gt;
&lt;/body&gt;
          </pre>
       </section>
       <section>
        <h3>
          Query and buy a product example
        </h3>
          <pre class="example highlight">
&lt;script&gt;
  function queryProduct() {
    iap.queryProductsInfo(["facebook"])).then(function(products) {
    document.getElementById("resultDiv").innerHTML = "";
    for (var i=0; i&lt;products.length; i++) {
      var productId = "ID: " + products[i]["productId"] + "&lt;br&gt;";
      var price = "Price: " + products[i]["price"] + "&lt;br&gt;";
      var description = "Description: " products[i]["description"] + "&lt;br&gt;";
      document.getElementById("resultDiv").innerHTML += productId + price + description;
    }}).catch(function(e) {
      console.log(e.name);
    });
  }
  
  function purchaseProduct() {
    iap.buy({productId:"facebook"}).then(function(result)) {
      document.getElementById("resultDiv").innerHTML = "";
      var transactionId = "Transaction: " + result["transactionId"] + "&lt;br&gt;";
      var receipt = "Receipt: " + result["productReceipt"] + "&lt;br&gt;";
      document.getElementById("resultDiv").innerHTML += transactionId + receipt;
    }).catch(function(e) {
      console.log(e.name);
    });
  }
&lt;/script&gt;

&lt;body&gt;
  &lt;button id="queryBtn" style="display: none;" onclick="queryProduct()"&gt;Query Product&lt;/button&gt;
  &lt;button id="purchaseBtn" style="display: none;" onclick="purchaseProduct()"&gt;Purchase Product&lt;/button&gt;
  &lt;div id="resultDiv"&gt;&lt;/div&gt;
&lt;/body&gt;
				</pre>
      </section>
    	<section>
        <h3>
          Get and validate receipt example
        </h3>
          <pre class="example highlight">
&lt;script&gt;
  function getReceipt() {
    iap.getReceipt().then(function(receipt) {
      iap.validateReceipt(receipt).then(function() {
        document.getElementById("resultDiv").innerHTML = "Validation passed!";
      }).catch(function() {
        document.getElementById("resultDiv").innerHTML = "Validation failed!";
      });
    }).catch(function(e) {
      console.log(e.name);
    });
  }
&lt;/script&gt;

&lt;body&gt;
  &lt;button id="queryBtn" style="display: none;" onclick="getReceipt()"&gt;Get and Validate receipt&lt;/button&gt;
  &lt;div id="resultDiv"&gt;&lt;/div&gt;
&lt;/body&gt;
				</pre>
      </section>
  </section>
  </body>
</html>
