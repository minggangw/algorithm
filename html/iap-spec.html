<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <title>
      In-App Purchase API
    </title>
    <script src='../js/require.js' data-main='../js/profile-w3c-common' async class='remove'></script>
    <script class="remove">
    var respecConfig = {
        specStatus: 'ED',
        edDraftURI: 'http://10.238.157.53/html/iap.html',
        shortName:  'IAP-api',
        editors: [
          {
            w3cid: 63802,
            name: 'Minggang Wang',
            company: 'Intel',
            note: 'until Nov 2015'
          }
        ],
        previousMaturity: 'WD',
        previousPublishDate: '2015-07-01',
        localBiblio: {
          PROMGUIDE: {
            title: 'Writing Promise-Using Specifications',
            href: 'http://www.w3.org/2001/tag/doc/promises-guide',
            authors: [
              'Domenic Denicola'
            ],
            status: 'finding',
            publisher: 'W3C'
          }
        },
      };
    </script>
    <style>
    /* Note formatting taken from HTML5 spec */
    .note { border-left-style: solid; border-left-width: 0.25em; background: none repeat scroll 0 0 #E9FBE9; border-color: #52E052; }
    .note em, .warning em, .note i, .warning i { font-style: normal; }
    p.note, div.note { padding: 0.5em 2em; }
    span.note { padding: 0 2em; }
    .note p:first-child { margin-top: 0; }
    .note p:last-child { margin-bottom: 0; }
    p.note:before { content: 'NOTE: '; }
    .non-normative { border-left-style: solid; border-left-width: 0.25em; background: none repeat scroll 0 0 #E9FBE9; border-color: #52E052; }
    p.non-normative:before { content: 'Non-normative: '; font-weight: bolder;}
    p.non-normative, div.non-normative { padding: 0.5em 2em; }


    /* Pre.idl formatting taken from HTML5 spec */
    pre.idl { border: solid thin #d3d3d3; background: #FCFCFC; color: black; padding: 0.5em 1em; position: relative; }
    pre.idl :link, pre.idl :visited { color: inherit; background: transparent; }
    pre.idl::before { content: "IDL"; font: bold small sans-serif;
    padding: 0.5em; background: white; position: absolute; top: 0;
    margin: -1px 0 0 -4em; width: 1.5em; border: thin solid;
    border-radius: 0 0 0 0.5em }

    /* .example idl formatting taken from HTML5 nightly spec */
    .example {
        display: block;
        color: #222222;
        background: #FCFCFC;
        border-left-style: solid;
        border-color: #c0c0c0;
        border-left-width: 0.25em;
        margin-left: 1em;
        padding-left: 1em;
        padding-bottom: 0.5em;
    }

    .algorithm li {
        margin-bottom: 0.5em;
    }

    .interface dd, .parameters dt {
        margin-bottom: 0.5em;
    }

    code { color: orangered; }
    table { border-collapse: collapse; border-style: hidden hidden none hidden; }
    table thead, table tbody { border-bottom: solid; }
    table td, table th { border-left: solid; border-right: solid; border-bottom: solid thin; vertical-align: top; padding: 0.2em; }
    dfn { font-weight: bolder; font-style: normal; }
    .copyright { font-size: small; }
    .issue[id^='issue-'] > *:not([role='heading']) { display: none; }
    </style>
  </head>
  <body>
    <section id="abstract">
      <p>
        This specification defines an API to enable in-app purchase on web.
      </p>
    </section>
    <section id="sotd">
      <p>
        This document is a <b>work in progress</b> and is subject to change.
        Some sections are still incomplete or underspecified. <a href=
        "#security-and-privacy-considerations">Security and privacy
        considerations</a> need to be adjusted based on feedback and
        experience. Some open issues are noted inline; please check the group's
        <a href="https://github.com/w3c/presentation-api/issues">issue
        tracker</a> on GitHub for all open issues.
      </p>
    </section>
    <section class="informative">
      <h2>
        Introduction
      </h2>
    </section>
  
    <section>
      <h2>
        Terminology
      </h2>
      <p>
        This document provides interface definitions using the Web IDL standard
        ([[!WEBIDL]]). The terms <dfn><a href=
        "https://heycam.github.io/webidl/#idl-promise">Promise</a></dfn>,
        <dfn><a href=
        "http://heycam.github.io/webidl/#idl-ArrayBuffer">ArrayBuffer</a></dfn>,
        <dfn><a href=
        "http://heycam.github.io/webidl/#idl-ArrayBufferView">ArrayBufferView</a></dfn>
        and <dfn><a href=
        "http://heycam.github.io/webidl/#idl-DOMException">DOMException</a></dfn>
        are defined in [[!WEBIDL]].
      </p>
      <p>
        The terms <dfn data-lt="resolve"><a href=
        "http://www.w3.org/2001/tag/doc/promises-guide#resolve-promise">resolving
        a Promise</a></dfn>, and <dfn data-lt="reject"><a href=
        "http://www.w3.org/2001/tag/doc/promises-guide#reject-promise">rejecting
        a Promise</a></dfn> are used as explained in [[!PROMGUIDE]].
      </p>
    </section>
    
    <section>
      <h2>
        API
      </h2>
      <section>
        <h3>
          Common idioms
        </h3>

      </section>
     
      <section>
        <h3>
          Interface <a><code>IAP</code></a>
        </h3>
        <pre class="idl">
          partial interface Navigator {
            [SameObject] readonly attribute IAP iap;
          };

        </pre>
        <p>
          The <dfn for="Navigator"><code>iap</code></dfn> attribute is
          used to retrieve an instance of the <a>IAP</a> interface.
        </p>
        <pre class="idl">
          interface IAP : EventTarget {
            // Initialize the purchase.
            Promise&lt;void&gt; init(InitOptions options);

            // Operations.
            Promise&lt;DOMString&gt; getReceipt();
            Promise&lt;void&gt; validateReceipt(DOMString receipt);
            Promise&lt;PurchaseResult&gt; restore();
            Promise&lt;PurchaseResult&gt; buy(PurchaseInfo purchase);
            Promise&lt;sequence&lt;Product&gt;&gt; queryProductsInfo(sequence&lt;DOMString&gt; productIds);
          };
				</pre>

        <section>
          <h4>
            Initializing the <code>iap</code>
          </h4>
          <p>
            When <code><dfn for="IAP">init</dfn>(options)</code> method is called, <code>iap</code> will
            be initiated by the given parameter <code>options</code>, which binds to the <a>channel</a>.
          </p>
          <ol>
            <li>If the object has already been initialized, return a promise rejected with
                a new DOMException whose name is InvalidStateError.
            </li>
            <li>
              If the channel of options is empty, return a promise rejected with a new Error
              whose name is TypeError.
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>Run the following steps:
              <ol>
                <li>
                  Initialize the specified channel.
                </li>
                <li>Wait until the initialization completes.
                </li>
              </ol>
            </li>
            <li>If the specified channel is not suppportd, then:
              <ol>
                <li>Reject P whith a Error named "Not supported".
                </li>
              </ol>
            </li>
            <li>If the error occurs during initialization, then:
              <ol>
                <li>
                  Reject P with the failed reason.
                </li>
              </ol>
            </li>
            <li>
              <a>Resolve</a> <em>promise</em>
            </li>
          </ol>
        </section>
        <section>
          <h4>
            Querying the detailed information of products.
          </h4>
          <p>
            When <code><dfn for="IAP">queryProductsInfo</dfn>(producdIds)</code> method is called,
            iap will get the detailed informations of the products, run the following
            steps
          </p>
          <ol>
            <li>
              If the object has not been initialized, return a promise rejected with
              a Error whose name is "not initialized".
            </li>
            <li>If the productIds is empty, return a promise rejected with a Error whose
                name is "empty product".
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
              Query the information.
            </li>
            <li>
              If a error occurs then:
              <ol>
                <li>
                  Reject P with the failed reasons.
                </li>
              </ol>
            </li>
            <li>
              If the querying completes successfully, then run the following steps:
              <ol>
                <li>
                  Let <em>array</em> be an empty array.
                </li>
                <li>
                  For each product, add its information to <em>array</em>
                </li>
                <li>
                  <a>Resolve</a> <em>P</em> with array.
                </li>
              </ol>
            </li>
          </ol>
        </section>
        <section>
          <h4>
            Purchasing a product.
          </h4>
          <p>
            When <code><dfn for="IAP">buy</dfn>(purchase)</code> method is called,
            iap will buy the assigned product. 
          </p>
          <ol>
            <li>
              If the object has not been initialized, return a promise rejected with
              a Error whose name is "not initialized".
            </li>
            <li>
              If the productId of the PurchaseInfo is empty, return a promise rejected
              with a Error whose name is "empty productId".
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
              If buying the product successfully, then run the following steps:
              <ol>
                <li>
                  Let <em>S</em> be the required product.
                </li>
                <li>
                <a>Resolve</a> <em>P</em> with S.
                </li>
              </ol>
            </li>
          </ol>
        </section>
        <section>
          <h4>
            Getting the receipt.
          </h4>
          <p>
            When <code><dfn for="IAP">getReceipt</dfn>()</code> method is called,
            iap will return the receipt of the corresponding channel.
          </p>
          <ol>
            <li>
              If the object has not been initialized, return a promise rejected with
              a Error whose name is "not initialized".
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
            If getting the receipt successfully, then run the following steps:
              <ol>
                <li>
                  <a>Resolve</a> <em>P</em> with the receipt.
                </li>
              </ol>
            </li>
          </ol>
        </section>
        <section>
          <h4>
            Validating the receipt.
          </h4>
          <p>
            When <code><dfn for="IAP">validateReceipt</dfn>()</code> method is called,
            iap will validate the receipt.
          </p>
          <ol>
            <li>
              If the object has not been initialized, return a promise rejected with
              a Error whose name is "not initialized".
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
            If getting the receipt successfully, then run the following steps:
              <ol>
                <li>
                  <a>Resolve</a> <em>P</em> with the receipt.
                </li>
              </ol>
            </li>
          </ol>
        </section>
        <section>
          <h4>
            Restoring the purchased products.
          </h4>
          <p>
            When <code><dfn for="IAP">restore</dfn>()</code> method is called,
            iap will restore the previous purchases.
          </p>
          <ol>
            <li>
              If the object has not been initialized, return a promise rejected with
              a Error whose name is "not initialized".
            </li>
            <li>
              Let <em>P</em> be a new <a>Promise</a>.
            </li>
            <li>
              Return <em>P</em>.
            </li>
            <li>
              If restoring successfully, then run the following steps:
              <ol>
                <li>
                  Let <em>S</em> be the required product.
                </li>
                <li>
                <a>Resolve</a> <em>P</em> with S.
                </li>
              </ol>
            </li>
          </ol>
        </section>

        <section>
        <h2>Dictionaries</h2>

        <dl class="idl" title="dictionary InitOptions">
          <dt>DOMString channel</dt>
          <dd>The name of the channel which you want to select.</dd>
          <dt>DOMString key</dt>
          <dd>The public licensing key of this application if it exists.</dd>
        </dl>

        <dl class="idl" title="dictionary Product">
          <dt>DOMString productId</dt>
          <dd>The ID of the product.</dd>
          <dt>DOMString title</dt>
          <dd>The title of the product.</dd>
          <dt>DOMString description</dt>
          <dd>A simple description of the product.</dd>
          <dt>DOMString currencyCode</dt>
          <dd>The currency code of this product used.</dd>
          <dt>double price</dt>
          <dd>The price of the product.</dd>
        </dl>

        <dl class="idl" title="dictionary PurchaseResult">
          <dt>DOMString productId</dt>
          <dd>The ID of the purchased product.</dd>
          <dt>DOMString transactionId</dt>
          <dd>The transaction ID of this purchase used.</dd>
          <dt>DOMString productReceipt</dt>
          <dd>The receipt of the purchased product.</dd>
          <dt>DOMString packageName</dt>
          <dd>The package name of the application.</dd>
          <dt>DOMString purchaseTime</dt>
          <dd>The time when the purchase happened</dd>
          <dt>DOMString purchaseState</dt>
          <dd>The state of the purchase.</dd>
        </dl>

        <dl class="idl" title="dictionary PurchaseInfo">
          <dt>DOMString productId</dt>
          <dd>The ID of the purchased product.</dd>
          <dt>DOMString userInfo</dt>
          <dd>The information of the user.</dd>
          <dt>unsigned long count</dt>
          <dd>The quantity of the product.</dd>
          <dt>double price</dt>
          <dd>The price of the product.</dd>
          <dt>dictionary extraInfo</dt>
          <dd>Additional information used to descript the purchase.</dd>
        </dl>
      </section>
    </section>
    <section>
      <h2>
        Security and privacy considerations
      </h2>
      <div class="issue" data-number="45"></div>
      <h3>
        Personally identifiable information
      </h3>
    </section>
    <section>
      <h2>
        Acknowledgments
      </h2>
      <p>
        Thanks to Wayne Carr, Louay Bassbouss, Anssi Kostiainen, 闵洪波 (Hongbo
        Min), Anton Vayvod, and Mark Foltz for help with editing, reviews and
        feedback to this draft.
      </p>
    </section>
  </body>
</html>
